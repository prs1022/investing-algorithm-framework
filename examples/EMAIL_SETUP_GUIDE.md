# 📧 邮件通知设置指南

## 快速开始

### 1. 获取 QQ 邮箱授权码

1. 登录 [QQ 邮箱](https://mail.qq.com/)
2. 点击 **设置** → **账户**
3. 找到 **POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务**
4. 开启 **IMAP/SMTP服务**
5. 点击 **生成授权码**
6. 按提示发送短信
7. 复制生成的授权码（16位字符）

**重要**：授权码不是你的 QQ 密码！

### 2. 配置 .env 文件

编辑 `examples/.env` 文件，添加：

```bash
# Gate.io API 配置
GATEIO_API_KEY=your_api_key_here
GATEIO_SECRET_KEY=your_secret_key_here

# 邮件通知配置
EMAIL_SENDER=1249366431@qq.com          # 你的 QQ 邮箱
EMAIL_AUTH_CODE=mnujgvbqkekbifge         # QQ 邮箱授权码
EMAIL_RECEIVER=1249366431@qq.com         # 接收通知的邮箱（可以是自己）
```

### 3. 测试邮件发送

```bash
cd examples
python send_qq_email.py
```

如果看到 "邮件发送成功！"，说明配置正确。

### 4. 运行带邮件通知的交易机器人

```bash
python gateio_live_trading_with_email.py
```

## 📬 邮件通知类型

### 1. 买入通知

**触发时机**：检测到持仓增加

**邮件内容**：
```
主题: 🟢 买入通知 - BTC

交易机器人买入通知
==================================================

📊 交易信息:
  币种: BTC
  数量: 0.00100000
  价格: $89,500.00
  成本: $89.50

💰 账户信息:
  当前总资产: $1,000.00

📝 买入原因:
  RSI 超卖 + EMA 交叉向上

⏰ 时间: 2025-11-12 14:30:00

==================================================
此邮件由交易机器人自动发送
```

### 2. 卖出通知

**触发时机**：检测到持仓减少

**邮件内容**：
```
主题: 🔴 卖出通知 - BTC (📈 +5.50%)

交易机器人卖出通知
==================================================

📊 交易信息:
  币种: BTC
  数量: 0.00100000
  价格: $94,500.00
  收入: $94.50

💵 盈亏情况:
  盈亏金额: $+5.00
  盈亏比例: +5.50%
  📈 盈利

💰 账户信息:
  当前总资产: $1,005.00

📝 卖出原因:
  RSI 超买 + EMA 交叉向下

⏰ 时间: 2025-11-12 16:30:00

==================================================
此邮件由交易机器人自动发送
```

### 3. 止损通知

**触发时机**：浮动亏损达到 30%

**邮件内容**：
```
主题: 🛑 止损警告 - 亏损 32.50%

⚠️ 交易机器人止损通知 ⚠️
==================================================

🛑 止损触发:
  总亏损: $-6.50
  亏损比例: 32.50%
  
💰 当前资产:
  总资产: $13.50

📊 持仓情况:
  BTC: $-4.00
  ETH: $-2.50

⚡ 已执行操作:
  ✅ 已平掉所有持仓
  ✅ 已停止新的交易

⏰ 时间: 2025-11-12 18:00:00

==================================================
请及时检查账户状态！
此邮件由交易机器人自动发送
```

### 4. 止盈通知

**触发时机**：达到斐波那契止盈点

**邮件内容**：
```
主题: 💰 止盈通知 - BTC (Level 1)

交易机器人止盈通知
==================================================

💰 止盈信息:
  币种: BTC
  级别: Level 1
  盈利: 3.00%

📊 交易详情:
  卖出数量: 0.00050000
  卖出价格: $92,185.00
  卖出比例: 50% (剩余 50%)

💵 账户信息:
  当前总资产: $1,015.00

⏰ 时间: 2025-11-12 15:00:00

==================================================
此邮件由交易机器人自动发送
```

## 🔧 工作原理

### 框架如何执行交易？

```
1. 策略生成信号
   ↓
2. 框架检测到信号
   ↓
3. 框架自动调用 CCXT API
   ↓
4. Gate.io 执行订单
   ↓
5. 框架更新持仓
   ↓
6. 我们的代码检测到持仓变化
   ↓
7. 发送邮件通知
```

### 持仓变化检测

```python
# 每次策略运行时
def run_strategy(self, context, data):
    # 1. 记录当前持仓
    last_positions = self.last_positions
    
    # 2. 执行策略（可能产生交易）
    super().run_strategy(context, data)
    
    # 3. 获取新的持仓
    current_positions = get_current_positions()
    
    # 4. 比较变化
    if current_positions['BTC'] > last_positions['BTC']:
        # 持仓增加 = 买入
        send_buy_email()
    elif current_positions['BTC'] < last_positions['BTC']:
        # 持仓减少 = 卖出
        send_sell_email()
```

## ⚙️ 自定义配置

### 修改邮件接收者

```bash
# .env 文件
EMAIL_RECEIVER=another_email@qq.com  # 发送到其他邮箱
```

### 禁用邮件通知

```bash
# 方法 1：注释掉 .env 中的邮件配置
# EMAIL_SENDER=...
# EMAIL_AUTH_CODE=...

# 方法 2：使用不带邮件的版本
python gateio_live_trading_with_risk_control.py
```

### 添加更多通知类型

编辑 `email_notifier.py`，添加新的通知方法：

```python
def send_custom_notification(self, ...):
    subject = "自定义通知"
    content = "..."
    return self.send_email(subject, content)
```

## 🐛 故障排查

### 问题 1：邮件发送失败

**错误**：`SMTPAuthenticationError`

**原因**：授权码错误或未开启 SMTP 服务

**解决**：
1. 检查授权码是否正确
2. 确认已开启 IMAP/SMTP 服务
3. 重新生成授权码

### 问题 2：收不到邮件

**可能原因**：
1. 邮件在垃圾箱
2. 邮箱地址错误
3. 邮件服务器延迟

**解决**：
1. 检查垃圾箱
2. 确认 EMAIL_RECEIVER 配置正确
3. 等待几分钟

### 问题 3：邮件通知未启用

**日志显示**：`⚠️  邮件通知未配置`

**原因**：.env 文件中缺少邮件配置

**解决**：
```bash
# 检查 .env 文件
cat .env | grep EMAIL

# 应该看到：
# EMAIL_SENDER=...
# EMAIL_AUTH_CODE=...
# EMAIL_RECEIVER=...
```

### 问题 4：没有收到买卖通知

**可能原因**：
1. 没有触发交易信号
2. 持仓检测失败
3. 邮件发送失败

**解决**：
1. 查看日志：`tail -f logs/latest.log`
2. 检查是否有 "🟢 检测到买入信号" 日志
3. 检查是否有 "📧 已发送...通知邮件" 日志

## 📊 邮件统计

### 预期邮件频率

| 事件 | 频率 |
|------|------|
| 买入通知 | 每次买入时 |
| 卖出通知 | 每次卖出时 |
| 止盈通知 | 达到止盈点时 |
| 止损通知 | 触发止损时（最多1次） |

**注意**：
- 策略每 2 小时运行一次
- 不是每次运行都会产生交易
- 可能几天都没有交易信号

### 减少邮件数量

如果邮件太多，可以：

1. **只发送重要通知**：
   ```python
   # 只发送止损和大额交易通知
   if cost > 100:  # 只有成本超过 $100 才发送
       send_email()
   ```

2. **合并通知**：
   ```python
   # 每天发送一次总结邮件
   send_daily_summary()
   ```

## 🔒 安全建议

1. **不要分享授权码**：授权码等同于密码
2. **定期更换**：建议每月更换授权码
3. **使用独立邮箱**：建议用专门的邮箱接收通知
4. **加密存储**：.env 文件不要提交到 git

## 📝 最佳实践

1. ✅ 先测试邮件发送功能
2. ✅ 使用自己的邮箱接收通知
3. ✅ 定期检查邮件是否正常
4. ✅ 保存重要的通知邮件
5. ✅ 设置邮件过滤规则（避免垃圾箱）

---

**提示**：邮件通知是辅助功能，不要完全依赖邮件。建议定期检查日志和账户状态。
