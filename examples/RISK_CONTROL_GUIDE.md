# 🛡️ 风险控制系统说明

## 📊 资金管理

### 初始配置
- **初始资金**: $20 USDT
- **每次开仓**: 10% (最多 $2 USDT)
- **最大同时持仓**: 2个币种 (BTC + ETH)

### 仓位计算
```python
PositionSize(
    symbol="BTC",
    percentage_of_portfolio=10.0  # 10% 的总资产
)
```

**示例**：
- 总资产 $20 → 每次开仓 $2
- 总资产 $30 → 每次开仓 $3
- 总资产 $15 → 每次开仓 $1.5

## 🛑 止损机制

### 浮动亏损止损
当**所有持仓的净浮动亏损**达到**当前总资产的 30%** 时触发：

**计算公式**：
```
净浮动亏损 = Σ(每个持仓的浮动盈亏)
止损条件 = |净浮动亏损| / 当前总资产 >= 30%
```

**示例**：
```
当前总资产: $15
持仓 A (BTC): -$10 (浮亏)
持仓 B (ETH): +$2 (浮盈)
净浮动亏损: -$8
亏损比例: |-8| / 15 = 53.3% >= 30% ✅ 触发止损
```

**为什么这样设计？**
- ✅ 更准确反映当前风险
- ✅ 考虑了部分盈利仓位的对冲
- ✅ 动态适应资产变化

**触发后动作**：
1. 🚨 立即平掉所有持仓
2. 🛑 停止所有新的交易
3. 📝 记录止损日志

### 代码实现
```python
def _check_stop_loss(self, context: Context) -> bool:
    current_value = portfolio.get_total_value()
    total_loss_pct = ((current_value - initial_capital) / initial_capital) * 100
    
    if total_loss_pct <= -30.0:
        # 触发止损
        self._emergency_close_all_positions(context)
        return True
```

## 💰 斐波那契止盈

### 止盈点位
使用斐波那契数列生成止盈百分比：

| 级别 | 百分比 | 动作 |
|------|--------|------|
| 1 | 3% | 止盈 50% |
| 2 | 5% | 止盈 50% |
| 3 | 8% | 止盈 50% |
| 4 | 13% | 止盈 50% |
| 5 | 21% | 止盈 50% |
| 6 | 34% | 止盈 50% |
| 7 | 55% | 止盈 50% |
| 8 | 89% | 止盈 50% |

### 止盈示例

**场景**: 以 $100 买入 BTC

| 价格 | 涨幅 | 触发级别 | 剩余仓位 | 已止盈 |
|------|------|----------|----------|--------|
| $100 | 0% | - | 100% | 0% |
| $103 | 3% | Level 1 | 50% | 50% |
| $105 | 5% | Level 2 | 25% | 75% |
| $108 | 8% | Level 3 | 12.5% | 87.5% |
| $113 | 13% | Level 4 | 6.25% | 93.75% |

### 代码实现
```python
def _check_fibonacci_profit_taking(self, context, symbol):
    profit_pct = (current_price - open_price) / open_price
    
    for i, fib_level in enumerate([0.03, 0.05, 0.08, 0.13, ...]):
        if profit_pct >= fib_level:
            # 卖出剩余仓位的 50%
            sell_amount = remaining_amount * 0.5
            context.create_limit_sell_order(symbol, sell_amount, current_price)
```

## 📈 实际运行示例

### 场景 1: 盈利情况
```
初始: $20
买入 BTC: $2 @ $100
买入 ETH: $2 @ $2000

BTC 涨到 $103 (+3%):
  → 触发 Level 1，卖出 50% ($1)
  → 剩余 BTC: $1

BTC 涨到 $105 (+5%):
  → 触发 Level 2，卖出 50% ($0.5)
  → 剩余 BTC: $0.5

总资产: $20.5 (+2.5%)
```

### 场景 2: 亏损情况
```
初始: $20
买入 BTC: $2 @ $100 (0.02 BTC)
买入 ETH: $2 @ $2000 (0.001 ETH)
剩余现金: $16

BTC 跌到 $80 (-20%)
  → BTC 浮亏: 0.02 * (80-100) = -$0.4
ETH 跌到 $1700 (-15%)
  → ETH 浮亏: 0.001 * (1700-2000) = -$0.3

当前总资产: $16 + $1.6 + $1.7 = $19.3
净浮动亏损: -$0.7
亏损比例: 0.7 / 19.3 = 3.6% < 30%
状态: 继续运行 ✅

BTC 继续跌到 $50 (-50%)
  → BTC 浮亏: 0.02 * (50-100) = -$1.0
ETH 继续跌到 $1500 (-25%)
  → ETH 浮亏: 0.001 * (1500-2000) = -$0.5

当前总资产: $16 + $1.0 + $1.5 = $18.5
净浮动亏损: -$1.5
亏损比例: 1.5 / 18.5 = 8.1% < 30%
状态: 继续运行 ✅

BTC 暴跌到 $20 (-80%)
  → BTC 浮亏: 0.02 * (20-100) = -$1.6
ETH 跌到 $1000 (-50%)
  → ETH 浮亏: 0.001 * (1000-2000) = -$1.0

当前总资产: $16 + $0.4 + $1.0 = $17.4
净浮动亏损: -$2.6
亏损比例: 2.6 / 17.4 = 14.9% < 30%
状态: 继续运行 ✅

极端情况：BTC 跌到 $10 (-90%)
  → BTC 浮亏: 0.02 * (10-100) = -$1.8
ETH 跌到 $500 (-75%)
  → ETH 浮亏: 0.001 * (500-2000) = -$1.5

当前总资产: $16 + $0.2 + $0.5 = $16.7
净浮动亏损: -$3.3
亏损比例: 3.3 / 16.7 = 19.8% < 30%
状态: 继续运行 ✅

超极端：BTC 归零，ETH 跌到 $200 (-90%)
  → BTC 浮亏: -$2.0
  → ETH 浮亏: 0.001 * (200-2000) = -$1.8

当前总资产: $16 + $0 + $0.2 = $16.2
净浮动亏损: -$3.8
亏损比例: 3.8 / 16.2 = 23.5% < 30%
状态: 继续运行 ✅

触发止损的情况（需要更大仓位或更大跌幅）：
假设买入 BTC: $10 @ $100 (0.1 BTC)
BTC 跌到 $40 (-60%)
  → BTC 浮亏: 0.1 * (40-100) = -$6.0

当前总资产: $10 + $4.0 = $14.0
净浮动亏损: -$6.0
亏损比例: 6.0 / 14.0 = 42.9% >= 30%
🚨 触发止损！
  → 立即平仓所有持仓
  → 停止交易
```

## 🔧 自定义配置

### 修改止损线
```python
class RiskControlledStrategy(TradingStrategy):
    MAX_LOSS_PCT = 20.0  # 改为 20% 止损
```

### 修改仓位大小
```python
position_sizes = [
    PositionSize(
        symbol="BTC",
        percentage_of_portfolio=5.0  # 改为 5%
    )
]
```

### 修改斐波那契数列
```python
def generate_fibonacci_levels(max_level: int = 10) -> List[float]:
    fib = [5, 10]  # 从 5%, 10% 开始
    # 生成: 5, 10, 15, 25, 40, 65...
```

### 修改止盈比例
```python
# 当前: 每次止盈 50%
sell_amount = remaining_amount * 0.5

# 改为: 每次止盈 30%
sell_amount = remaining_amount * 0.3
```

## 📊 监控建议

### 关键指标
1. **总资产**: 实时监控是否接近止损线
2. **持仓盈亏**: 每个币种的盈亏百分比
3. **止盈历史**: 已触发的止盈级别
4. **剩余仓位**: 每个交易的剩余数量

### 日志示例
```
📊 Portfolio Status: $21.50 (PnL: +7.50%) | Unallocated: $17.50
🟢 BUY SIGNAL: BTC | RSI: 28.50 | Position size: 10%
💰 FIBONACCI PROFIT TAKING! BTC at 3% profit (Level 1). Selling 50%
💰 FIBONACCI PROFIT TAKING! BTC at 5% profit (Level 2). Selling 50%
🛑 STOP LOSS TRIGGERED! Total loss: -30.50% ($13.90 / $20.00)
🚨 EMERGENCY CLOSE ALL POSITIONS! Closing 2 trades
```

## ⚠️ 重要提示

### 优点
✅ 自动止损，限制最大亏损
✅ 分批止盈，锁定利润
✅ 仓位控制，避免过度风险
✅ 无需人工干预

### 局限
⚠️ 止盈可能过早（错过大涨）
⚠️ 止损可能在底部（错过反弹）
⚠️ 需要稳定网络连接
⚠️ 交易手续费会影响收益

### 建议
1. **先回测**: 确保策略在历史数据上表现良好
2. **小资金**: 从 $20-50 开始测试
3. **监控运行**: 前几天密切关注
4. **调整参数**: 根据实际情况优化
5. **记录日志**: 保存所有交易记录

## 🚀 运行命令

```bash
# 运行带风险控制的实盘交易
python examples/gateio_live_trading_with_risk_control.py
```

## 📞 紧急情况

### 如何手动停止
1. 按 `Ctrl+C` 停止程序
2. 登录 Gate.io 网页
3. 手动平掉所有持仓

### 如何恢复
1. 检查日志文件
2. 确认当前持仓
3. 调整参数后重新启动

---

**风险提示**: 加密货币交易有风险，即使有风险控制系统，也可能导致资金损失。请谨慎交易！
